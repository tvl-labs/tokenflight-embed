---
/* Playground.astro — Interactive three-column widget playground */
---

<div class="pg-playground not-content" id="pg-root">
  <div class="pg-container">
    <!-- Mode tabs -->
    <div class="pg-mode-bar">
      <button class="pg-mode-tab pg-mode-tab--active" data-mode="swap">Swap</button>
      <button class="pg-mode-tab" data-mode="receive">Receive</button>
    </div>

    <div class="pg-grid">
      <!-- ─── Controls Panel ─── -->
      <div class="pg-controls">
        <div class="pg-section">
          <div class="pg-section-label">Accent</div>
          <div class="pg-presets">
            <label class="pg-preset" data-color="#6C5CE7" title="Default">
              <input type="radio" name="pg-accent" value="#6C5CE7" checked />
              <span class="pg-dot" style="background:#6C5CE7"></span>
            </label>
            <label class="pg-preset" data-color="#000000" title="X">
              <input type="radio" name="pg-accent" value="#000000" />
              <span class="pg-dot" style="background:#000000"></span>
            </label>
            <label class="pg-preset" data-color="#1185FE" title="Bsky">
              <input type="radio" name="pg-accent" value="#1185FE" />
              <span class="pg-dot" style="background:#1185FE"></span>
            </label>
            <label class="pg-preset" data-color="#55D292" title="pump.fun">
              <input type="radio" name="pg-accent" value="#55D292" />
              <span class="pg-dot" style="background:#55D292"></span>
            </label>
            <label class="pg-preset" data-color="#FF007A" title="Uniswap">
              <input type="radio" name="pg-accent" value="#FF007A" />
              <span class="pg-dot" style="background:#FF007A"></span>
            </label>
            <label class="pg-preset pg-preset--custom" data-color="custom" title="Custom">
              <input type="radio" name="pg-accent" value="custom" />
              <span class="pg-dot pg-dot--custom">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M2 22l1-1h3l9-9-3-3-9 9v3l-1 1z"/>
                  <path d="M15 6l3-3 3 3-3 3"/>
                </svg>
              </span>
              <input type="color" class="pg-color-picker" id="pg-custom-color" value="#E040FB" />
            </label>
          </div>
          <div class="pg-preset-name" id="pg-preset-name">Default</div>
        </div>

        <hr class="pg-divider" />

        <div class="pg-section">
          <div class="pg-section-label">Language</div>
          <select class="pg-select" id="pg-language">
            <option value="en-US">English</option>
            <option value="zh-CN">简体中文</option>
            <option value="zh-TW">繁體中文</option>
            <option value="ja-JP">日本語</option>
            <option value="ko-KR">한국어</option>
          </select>
        </div>

        <hr class="pg-divider" />

        <div class="pg-section">
          <div class="pg-section-label">Display</div>
          <label class="pg-toggle">
            <input type="checkbox" id="pg-hide-title" />
            <span>Hide title</span>
          </label>
          <label class="pg-toggle">
            <input type="checkbox" id="pg-hide-powered-by" />
            <span>Hide powered by</span>
          </label>
          <label class="pg-toggle">
            <input type="checkbox" id="pg-no-background" />
            <span>No background</span>
          </label>
          <label class="pg-toggle">
            <input type="checkbox" id="pg-no-border" />
            <span>No border</span>
          </label>
          <label class="pg-input-label" for="pg-title-text">Title Text</label>
          <input type="text" class="pg-input" id="pg-title-text" placeholder="TokenFlight" />
          <label class="pg-input-label" for="pg-title-image">Title Image URL</label>
          <input type="text" class="pg-input" id="pg-title-image" placeholder="https://example.com/logo.png" />
        </div>

        <hr class="pg-divider" />

        <!-- Swap-specific props -->
        <div class="pg-section pg-swap-props" id="pg-swap-props">
          <div class="pg-section-label">From Token</div>
          <select class="pg-select" id="pg-from-token">
            <option value="">None (user picks)</option>
            <option value="eip155:1:0x0000000000000000000000000000000000000000">ETH — Ethereum</option>
            <option value="eip155:1:0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48">USDC — Ethereum</option>
            <option value="eip155:1:0xdAC17F958D2ee523a2206206994597C13D831ec7">USDT — Ethereum</option>
            <option value="eip155:8453:0x0000000000000000000000000000000000000000">ETH — Base</option>
            <option value="eip155:42161:0x0000000000000000000000000000000000000000">ETH — Arbitrum</option>
            <option value="eip155:137:0x0000000000000000000000000000000000000000">POL — Polygon</option>
          </select>

          <div class="pg-section-label">To Token</div>
          <select class="pg-select" id="pg-to-token">
            <option value="" selected>None (user picks)</option>
            <option value="eip155:8453:0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913">USDC — Base</option>
            <option value="eip155:1:0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48">USDC — Ethereum</option>
            <option value="eip155:42161:0xaf88d065e77c8cC2239327C5EDb3A432268e5831">USDC — Arbitrum</option>
            <option value="eip155:1:0x0000000000000000000000000000000000000000">ETH — Ethereum</option>
            <option value="eip155:8453:0x0000000000000000000000000000000000000000">ETH — Base</option>
          </select>

        </div>

        <!-- Receive-specific props -->
        <div class="pg-section pg-receive-props" id="pg-receive-props" style="display:none">
          <div class="pg-section-label">Target Token</div>
          <select class="pg-select" id="pg-target-token">
            <option value="eip155:8453:0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913" selected>USDC — Base</option>
            <option value="eip155:1:0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48">USDC — Ethereum</option>
            <option value="eip155:42161:0xaf88d065e77c8cC2239327C5EDb3A432268e5831">USDC — Arbitrum</option>
            <option value="eip155:1:0xdAC17F958D2ee523a2206206994597C13D831ec7">USDT — Ethereum</option>
            <option value="eip155:1:0x0000000000000000000000000000000000000000">ETH — Ethereum</option>
          </select>

          <div class="pg-section-label">Amount</div>
          <input type="text" class="pg-input" id="pg-amount" value="100" />
        </div>
      </div>

      <!-- ─── Widget Preview ─── -->
      <div class="pg-widget">
        <div class="pg-widget-mount" id="pg-widget-mount"></div>
      </div>

      <!-- ─── Code Preview ─── -->
      <div class="pg-code">
        <div class="pg-code-bar">
          <div class="pg-code-bar-left">
            <div class="pg-code-tabs">
              <button class="pg-code-tab pg-code-tab--active" data-tab="html">HTML</button>
              <button class="pg-code-tab" data-tab="react">React</button>
              <button class="pg-code-tab" data-tab="vue">Vue</button>
            </div>
            <select class="pg-code-usage-select" id="pg-code-usage" aria-label="Code style">
              <option value="imperative">Imperative</option>
              <option value="declarative">Declarative</option>
            </select>
          </div>
          <button class="pg-copy-btn" id="pg-copy-btn" title="Copy to clipboard">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
            <span class="pg-copy-label">Copy</span>
          </button>
        </div>
        <div class="pg-code-scroll">
          <pre class="pg-pre"><code id="pg-code-output"></code></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  import { TokenFlightSwap, TokenFlightReceive, registerElements } from '@tokenflight/swap';
  import { getWalletAdapter } from '../lib/appkit';
  import Prism from 'prismjs';
  import 'prismjs/components/prism-markup';
  import 'prismjs/components/prism-javascript';
  import 'prismjs/components/prism-jsx';

  registerElements();

  const walletAdapter = await getWalletAdapter();

  /* ── State ── */
  const state = {
    mode: 'swap' as 'swap' | 'receive',
    accent: '#6C5CE7',
    customColor: '#E040FB',
    language: 'en-US',
    hideTitle: false,
    hidePoweredBy: false,
    noBackground: false,
    noBorder: false,
    titleText: '',
    titleImageUrl: '',
    codeTab: 'html' as 'html' | 'react' | 'vue',
    codeUsage: 'imperative' as 'imperative' | 'declarative',
    fromToken: '',
    toToken: '',
    targetToken: 'eip155:8453:0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',
    amount: '100',
  };

  /* ── DOM refs ── */
  const root = document.getElementById('pg-root')!;
  const mount = document.getElementById('pg-widget-mount')!;
  const codeOutput = document.getElementById('pg-code-output')!;
  const copyBtn = document.getElementById('pg-copy-btn')!;
  const copyLabel = copyBtn.querySelector('.pg-copy-label')!;
  const codeUsageSelect = document.getElementById('pg-code-usage') as HTMLSelectElement;

  let widget: InstanceType<typeof TokenFlightSwap> | InstanceType<typeof TokenFlightReceive> | null = null;

  /* ── Helpers ── */
  function getPageTheme(): 'dark' | 'light' {
    return document.documentElement.dataset.theme === 'light' ? 'light' : 'dark';
  }

  function getActiveAccent(): string {
    return state.accent === 'custom' ? state.customColor : state.accent;
  }

  function isDefaultAccent(): boolean {
    return getActiveAccent() === '#6C5CE7';
  }

  function parseCaip(caip: string): { chainId: number; address: string } | null {
    const parts = caip.split(':');
    if (parts.length === 3 && parts[0] === 'eip155') {
      return { chainId: parseInt(parts[1], 10), address: parts[2] };
    }
    return null;
  }

  /* ── Widget lifecycle ── */
  function createWidget() {
    if (widget) {
      widget.destroy();
      widget = null;
    }

    const theme = getPageTheme();
    const accent = getActiveAccent();
    const colors = isDefaultAccent() ? undefined : { primary: accent };

    if (state.mode === 'swap') {
      const config: Record<string, unknown> = {
        theme,
        locale: state.language,
      };
      if (state.hideTitle) config.hideTitle = true;
      if (state.hidePoweredBy) config.hidePoweredBy = true;
      if (state.noBackground) config.noBackground = true;
      if (state.noBorder) config.noBorder = true;
      if (state.titleText.trim()) config.titleText = state.titleText.trim();
      if (state.titleImageUrl.trim()) config.titleImageUrl = state.titleImageUrl.trim();
      if (colors) config.customColors = colors;
      if (state.fromToken) config.fromToken = state.fromToken;
      if (state.toToken) config.toToken = state.toToken;

      widget = new TokenFlightSwap({
        container: mount,
        config: config as any,
        walletAdapter: walletAdapter ?? undefined,
      });
    } else {
      const parsed = parseCaip(state.targetToken);
      const target = parsed ?? { chainId: 8453, address: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913' };

      const config: Record<string, unknown> = {
        target,
        amount: state.amount,
        theme,
        locale: state.language,
      };
      if (state.hideTitle) config.hideTitle = true;
      if (state.hidePoweredBy) config.hidePoweredBy = true;
      if (state.noBackground) config.noBackground = true;
      if (state.noBorder) config.noBorder = true;
      if (state.titleText.trim()) config.titleText = state.titleText.trim();
      if (state.titleImageUrl.trim()) config.titleImageUrl = state.titleImageUrl.trim();
      if (colors) config.customColors = colors;

      widget = new TokenFlightReceive({
        container: mount,
        config: config as any,
        walletAdapter: walletAdapter ?? undefined,
      });
    }

    widget.initialize();
  }

  /* ── Code generation ── */
  const prismLangMap: Record<string, string> = {
    html: 'markup',
    react: 'jsx',
    vue: 'markup',
  };

  function highlight(code: string): string {
    const lang = prismLangMap[state.codeTab] || 'markup';
    const grammar = Prism.languages[lang];
    if (!grammar) return code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    return Prism.highlight(code, grammar, lang);
  }

  function buildConfigLines(indent: string): string[] {
    const lines: string[] = [];
    const accent = getActiveAccent();

    if (state.language !== 'en-US') {
      lines.push(`${indent}locale: '${state.language}',`);
    }
    if (state.hideTitle) {
      lines.push(`${indent}hideTitle: true,`);
    }
    if (state.hidePoweredBy) {
      lines.push(`${indent}hidePoweredBy: true,`);
    }
    if (state.noBackground) {
      lines.push(`${indent}noBackground: true,`);
    }
    if (state.noBorder) {
      lines.push(`${indent}noBorder: true,`);
    }
    if (state.titleText.trim()) {
      lines.push(`${indent}titleText: '${state.titleText.trim()}',`);
    }
    if (state.titleImageUrl.trim()) {
      lines.push(`${indent}titleImageUrl: '${state.titleImageUrl.trim()}',`);
    }
    if (!isDefaultAccent()) {
      lines.push(`${indent}customColors: { primary: '${accent}' },`);
    }

    if (state.mode === 'swap') {
      if (state.fromToken) lines.push(`${indent}fromToken: '${state.fromToken}',`);
      if (state.toToken) lines.push(`${indent}toToken: '${state.toToken}',`);
    } else {
      const parsed = parseCaip(state.targetToken);
      if (parsed) {
        lines.push(`${indent}target: { chainId: ${parsed.chainId}, address: '${parsed.address}' },`);
      }
      lines.push(`${indent}amount: '${state.amount}',`);
    }

    return lines;
  }

  function buildDeclarativeTagAttrs(): { tag: string; attrs: string[] } {
    const tag = state.mode === 'swap' ? 'tokenflight-swap' : 'tokenflight-receive';
    const attrs: string[] = [];
    if (state.language !== 'en-US') attrs.push(`locale="${state.language}"`);
    if (state.hideTitle) attrs.push(`hide-title`);
    if (state.hidePoweredBy) attrs.push(`hide-powered-by`);
    if (state.noBackground) attrs.push(`no-background`);
    if (state.noBorder) attrs.push(`no-border`);
    if (state.titleText.trim()) attrs.push(`title-text="${state.titleText.trim()}"`);
    if (state.titleImageUrl.trim()) attrs.push(`title-image="${state.titleImageUrl.trim()}"`);

    if (state.mode === 'swap') {
      if (state.fromToken) attrs.push(`from-token="${state.fromToken}"`);
      if (state.toToken) attrs.push(`to-token="${state.toToken}"`);
    } else {
      attrs.push(`target='${JSON.stringify(parseCaip(state.targetToken))}'`);
      attrs.push(`amount="${state.amount}"`);
    }

    return { tag, attrs };
  }

  function buildSelfClosingTagLines(tag: string, attrs: string[], baseIndent = '  '): string[] {
    if (attrs.length === 0) {
      return [`${baseIndent}<${tag} />`];
    }

    const firstLine = `${baseIndent}<${tag}`;
    const attrLines = attrs.map((attr) => `${baseIndent}  ${attr}`);
    const lastLine = `${baseIndent}/>`;
    return [firstLine, ...attrLines, lastLine];
  }

  function genHTML(): string {
    const { tag, attrs } = buildDeclarativeTagAttrs();
    const tagLines = buildSelfClosingTagLines(tag, attrs, '');
    const lines = [
      `<script type="module">`,
      `  import { registerElements } from '@tokenflight/swap';`,
      `  registerElements();`,
      `<\/script>`,
      ``,
      ...tagLines,
    ];

    if (!isDefaultAccent()) {
      const accent = getActiveAccent();
      lines.push('');
      lines.push(`<script type="module">`);
      lines.push(`  // Apply custom accent color`);
      lines.push(`  const el = document.querySelector('${tag}');`);
      lines.push(`  el.setCustomColors({ primary: '${accent}' });`);
      lines.push(`<\/script>`);
    }

    return lines.join('\n');
  }

  function genReactDeclarative(): string {
    const { tag, attrs } = buildDeclarativeTagAttrs();
    const tagLines = buildSelfClosingTagLines(tag, attrs, '      ');

    if (isDefaultAccent()) {
      return [
        `import { registerElements } from '@tokenflight/swap';`,
        ``,
        `registerElements();`,
        ``,
        `export function Widget() {`,
        `  return (`,
        ...tagLines,
        `  );`,
        `}`,
      ].join('\n');
    }

    const accent = getActiveAccent();
    return [
      `import { useEffect, useRef } from 'react';`,
      `import { registerElements } from '@tokenflight/swap';`,
      ``,
      `registerElements();`,
      ``,
      `export function Widget() {`,
      `  const elRef = useRef<HTMLElement | null>(null);`,
      ``,
      `  useEffect(() => {`,
      `    elRef.current?.setCustomColors({ primary: '${accent}' });`,
      `  }, []);`,
      ``,
      `  return (`,
      ...tagLines.map((line, index) => {
        if (index === 0 && tagLines.length === 1) {
          return `      <${tag} ref={elRef} />`;
        }
        if (index === 0) {
          return `${line} ref={elRef}`;
        }
        return line;
      }),
      `  );`,
      `}`,
    ].join('\n');
  }

  function genReact(): string {
    if (state.codeUsage === 'declarative') {
      return genReactDeclarative();
    }

    const cls = state.mode === 'swap' ? 'TokenFlightSwap' : 'TokenFlightReceive';
    const configLines = buildConfigLines('      ');
    return [
      `import { useEffect, useRef } from 'react';`,
      `import { ${cls} } from '@tokenflight/swap';`,
      ``,
      `export function Widget() {`,
      `  const ref = useRef(null);`,
      ``,
      `  useEffect(() => {`,
      `    const w = new ${cls}({`,
      `      container: ref.current,`,
      `      config: {`,
      ...configLines,
      `      },`,
      `    });`,
      `    w.initialize();`,
      `    return () => w.destroy();`,
      `  }, []);`,
      ``,
      `  return <div ref={ref} />;`,
      `}`,
    ].join('\n');
  }

  function genVueDeclarative(): string {
    const { tag, attrs } = buildDeclarativeTagAttrs();
    const tagLines = buildSelfClosingTagLines(tag, attrs, '  ');

    if (isDefaultAccent()) {
      return [
        `<script setup>`,
        `import { registerElements } from '@tokenflight/swap';`,
        ``,
        `registerElements();`,
        `<\/script>`,
        ``,
        `<template>`,
        ...tagLines,
        `</template>`,
      ].join('\n');
    }

    const accent = getActiveAccent();
    return [
      `<script setup>`,
      `import { ref, onMounted } from 'vue';`,
      `import { registerElements } from '@tokenflight/swap';`,
      ``,
      `registerElements();`,
      `const el = ref(null);`,
      ``,
      `onMounted(() => {`,
      `  el.value?.setCustomColors({ primary: '${accent}' });`,
      `});`,
      `<\/script>`,
      ``,
      `<template>`,
      ...tagLines.map((line, index) => {
        if (index === 0 && tagLines.length === 1) {
          return `  <${tag} ref="el" />`;
        }
        if (index === 0) {
          return `${line} ref="el"`;
        }
        return line;
      }),
      `</template>`,
    ].join('\n');
  }

  function genVue(): string {
    if (state.codeUsage === 'declarative') {
      return genVueDeclarative();
    }

    const cls = state.mode === 'swap' ? 'TokenFlightSwap' : 'TokenFlightReceive';
    const configLines = buildConfigLines('      ');
    return [
      `<script setup>`,
      `import { ref, onMounted, onUnmounted } from 'vue';`,
      `import { ${cls} } from '@tokenflight/swap';`,
      ``,
      `const el = ref(null);`,
      `let widget;`,
      ``,
      `onMounted(() => {`,
      `  widget = new ${cls}({`,
      `    container: el.value,`,
      `    config: {`,
      ...configLines,
      `    },`,
      `  });`,
      `  widget.initialize();`,
      `});`,
      ``,
      `onUnmounted(() => widget?.destroy());`,
      `<\/script>`,
      ``,
      `<template>`,
      `  <div ref="el" />`,
      `</template>`,
    ].join('\n');
  }

  function updateCode() {
    let raw = '';
    switch (state.codeTab) {
      case 'html': raw = genHTML(); break;
      case 'react': raw = genReact(); break;
      case 'vue': raw = genVue(); break;
    }
    codeOutput.innerHTML = highlight(raw);
    // Reset copy button
    copyLabel.textContent = 'Copy';
  }

  function getRawCode(): string {
    switch (state.codeTab) {
      case 'html': return genHTML();
      case 'react': return genReact();
      case 'vue': return genVue();
    }
    return '';
  }

  function syncCodeUsageControl() {
    const isDeclarativeSupported = state.codeTab === 'react' || state.codeTab === 'vue';
    codeUsageSelect.disabled = !isDeclarativeSupported;
    codeUsageSelect.style.opacity = isDeclarativeSupported ? '1' : '0.55';
  }

  /* ── Event wiring ── */

  // Mode tabs
  root.querySelectorAll('.pg-mode-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      const mode = (btn as HTMLElement).dataset.mode as 'swap' | 'receive';
      if (mode === state.mode) return;
      state.mode = mode;
      root.querySelectorAll('.pg-mode-tab').forEach(b => b.classList.remove('pg-mode-tab--active'));
      btn.classList.add('pg-mode-tab--active');
      document.getElementById('pg-swap-props')!.style.display = mode === 'swap' ? '' : 'none';
      document.getElementById('pg-receive-props')!.style.display = mode === 'receive' ? '' : 'none';
      createWidget();
      updateCode();
    });
  });

  // Preset name map
  const presetNames: Record<string, string> = {
    '#6C5CE7': 'Default',
    '#000000': 'X',
    '#1185FE': 'Bsky',
    '#55D292': 'pump.fun',
    '#FF007A': 'Uniswap',
    'custom': 'Custom',
  };
  const presetNameEl = document.getElementById('pg-preset-name')!;

  function updatePresetName() {
    presetNameEl.textContent = state.accent === 'custom'
      ? `Custom ${state.customColor}`
      : (presetNames[state.accent] || 'Default');
  }

  // Accent presets
  root.querySelectorAll<HTMLInputElement>('input[name="pg-accent"]').forEach(radio => {
    radio.addEventListener('change', () => {
      state.accent = radio.value;
      if (radio.value === 'custom') {
        state.accent = 'custom';
      }
      const accent = getActiveAccent();
      if (widget) {
        widget.setCustomColors({ primary: accent });
      }
      updatePresetName();
      updateCode();
    });
  });

  // Custom color picker
  const colorPicker = document.getElementById('pg-custom-color') as HTMLInputElement;
  colorPicker.addEventListener('input', () => {
    state.customColor = colorPicker.value;
    // Select the custom radio
    const customRadio = root.querySelector<HTMLInputElement>('input[name="pg-accent"][value="custom"]');
    if (customRadio) customRadio.checked = true;
    state.accent = 'custom';
    if (widget) {
      widget.setCustomColors({ primary: state.customColor });
    }
    updatePresetName();
    updateCode();
  });

  // Language
  document.getElementById('pg-language')!.addEventListener('change', (e) => {
    state.language = (e.target as HTMLSelectElement).value;
    createWidget();
    updateCode();
  });

  document.getElementById('pg-hide-title')!.addEventListener('change', (e) => {
    state.hideTitle = (e.target as HTMLInputElement).checked;
    createWidget();
    updateCode();
  });

  document.getElementById('pg-hide-powered-by')!.addEventListener('change', (e) => {
    state.hidePoweredBy = (e.target as HTMLInputElement).checked;
    createWidget();
    updateCode();
  });

  document.getElementById('pg-no-background')!.addEventListener('change', (e) => {
    state.noBackground = (e.target as HTMLInputElement).checked;
    createWidget();
    updateCode();
  });

  document.getElementById('pg-no-border')!.addEventListener('change', (e) => {
    state.noBorder = (e.target as HTMLInputElement).checked;
    createWidget();
    updateCode();
  });

  document.getElementById('pg-title-text')!.addEventListener('input', (e) => {
    state.titleText = (e.target as HTMLInputElement).value;
    createWidget();
    updateCode();
  });

  document.getElementById('pg-title-image')!.addEventListener('input', (e) => {
    state.titleImageUrl = (e.target as HTMLInputElement).value;
    createWidget();
    updateCode();
  });

  // Swap props
  document.getElementById('pg-from-token')!.addEventListener('change', (e) => {
    state.fromToken = (e.target as HTMLSelectElement).value;
    createWidget();
    updateCode();
  });
  document.getElementById('pg-to-token')!.addEventListener('change', (e) => {
    state.toToken = (e.target as HTMLSelectElement).value;
    createWidget();
    updateCode();
  });

  // Receive props
  document.getElementById('pg-target-token')!.addEventListener('change', (e) => {
    state.targetToken = (e.target as HTMLSelectElement).value;
    createWidget();
    updateCode();
  });
  document.getElementById('pg-amount')!.addEventListener('change', (e) => {
    state.amount = (e.target as HTMLInputElement).value || '100';
    createWidget();
    updateCode();
  });

  // Code tabs
  root.querySelectorAll('.pg-code-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = (btn as HTMLElement).dataset.tab as 'html' | 'react' | 'vue';
      state.codeTab = tab;
      root.querySelectorAll('.pg-code-tab').forEach(b => b.classList.remove('pg-code-tab--active'));
      btn.classList.add('pg-code-tab--active');
      syncCodeUsageControl();
      updateCode();
    });
  });

  codeUsageSelect.addEventListener('change', (e) => {
    state.codeUsage = (e.target as HTMLSelectElement).value as 'imperative' | 'declarative';
    updateCode();
  });

  // Copy
  copyBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(getRawCode());
      copyLabel.textContent = 'Copied!';
      setTimeout(() => { copyLabel.textContent = 'Copy'; }, 1500);
    } catch {}
  });

  // Starlight dark/light toggle → sync widget theme
  const observer = new MutationObserver(() => {
    const theme = getPageTheme();
    if (widget) {
      widget.setTheme(theme);
    }
    updateCode();
  });
  observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });

  /* ── Init ── */
  createWidget();
  syncCodeUsageControl();
  updateCode();
</script>

<style>
  /* ── Layout ── */
  .pg-playground {
    margin: 1rem 0 2rem;
  }

  /* ── Container with accent top bar ── */
  .pg-container {
    border: 1px solid var(--pg-border);
    border-radius: 20px;
    overflow: hidden;
    position: relative;
    background: var(--pg-surface);
  }

  .pg-container::before {
    content: '';
    display: block;
    height: 2px;
    background: linear-gradient(90deg, var(--sl-color-accent), var(--sl-color-accent-high), var(--sl-color-accent));
  }

  /* ── Mode Tabs (pill style) ── */
  .pg-mode-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    width: fit-content;
    margin: 0.75rem auto 0;
    padding: 4px;
    border: 1px solid var(--pg-border);
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.03);
  }

  .pg-mode-tab {
    min-width: 108px;
    padding: 0.48rem 1rem;
    border: 1px solid transparent;
    border-radius: 999px;
    background: transparent;
    color: var(--pg-text-secondary);
    font-size: 0.875rem;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    transition: border-color 0.15s, background 0.15s, color 0.15s;
  }

  .pg-mode-tab:hover {
    color: var(--pg-text);
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.08);
  }

  .pg-mode-tab--active {
    color: #fff;
    background: var(--sl-color-accent);
    border-color: transparent;
  }

  /* ── Grid ── */
  .pg-grid {
    display: grid;
    grid-template-columns: 220px 420px 1fr;
    align-items: stretch;
    min-height: 520px;
    height: auto;
    background:
      radial-gradient(ellipse at 30% 40%, var(--sl-color-accent-low) 0%, transparent 60%),
      radial-gradient(ellipse at 70% 60%, var(--sl-color-accent-low) 0%, transparent 60%),
      var(--pg-surface);
  }

  /* ── Controls ── */
  .pg-controls {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 1rem;
    background: transparent;
    border-right: 1px solid var(--pg-border);
  }

  .pg-divider {
    border: none;
    border-top: 1px solid var(--pg-border);
    margin: 0.35rem 0;
  }

  .pg-section {
    margin-bottom: 0.25rem;
  }

  .pg-section-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--pg-text-secondary);
    margin-bottom: 8px;
  }

  .pg-presets {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
  }

  .pg-preset {
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
  }

  .pg-preset input[type="radio"] {
    display: none;
  }

  .pg-dot {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    flex-shrink: 0;
    border: 2px solid transparent;
    transition: border-color 0.15s, box-shadow 0.15s;
    cursor: pointer;
  }

  .pg-dot:hover {
    opacity: 0.85;
  }

  .pg-preset:has(input:checked) .pg-dot {
    border-color: currentColor;
    box-shadow: 0 0 0 2px var(--pg-surface), 0 0 0 4px currentColor;
  }

  .pg-preset-name {
    font-size: 11px;
    color: var(--pg-text-secondary);
    margin-top: 2px;
  }

  .pg-dot--custom {
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--pg-input-bg);
    border: 2px dashed var(--pg-border);
    color: var(--pg-text-secondary);
  }

  .pg-dot--custom:hover {
    border-color: var(--pg-text-secondary);
    color: var(--pg-text);
    opacity: 1;
  }

  .pg-color-picker {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
    -webkit-appearance: none;
    border: none;
    padding: 0;
  }

  .pg-select,
  .pg-input {
    width: 100%;
    height: 36px;
    padding: 0 12px;
    background: var(--pg-input-bg);
    border: 1px solid var(--pg-border);
    border-radius: 6px;
    color: var(--pg-text);
    font-size: 13px;
    font-family: inherit;
    margin-bottom: 14px;
    outline: none;
    transition: border-color 0.15s;
  }

  .pg-select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    padding-right: 40px;
    background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 14 14" fill="none"%3E%3Cpath d="M3 5.25L7 9.25L11 5.25" stroke="%23C8CDD9" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/%3E%3C/svg%3E');
    background-repeat: no-repeat;
    background-position: right 14px center;
    background-size: 14px 14px;
  }

  .pg-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--pg-text);
    margin-bottom: 10px;
    cursor: pointer;
    user-select: none;
  }

  .pg-toggle input[type='checkbox'] {
    width: 14px;
    height: 14px;
    margin: 0;
    accent-color: var(--sl-color-accent);
    cursor: pointer;
  }

  .pg-input-label {
    display: block;
    font-size: 11px;
    color: var(--pg-text-secondary);
    margin: 0 0 6px;
  }

  .pg-select:focus,
  .pg-input:focus {
    border-color: var(--sl-color-accent);
  }

  /* ── Code Preview (always dark, semi-transparent over gradient) ── */
  .pg-code {
    display: flex;
    flex-direction: column;
    background: rgba(13, 15, 20, 0.5);
    overflow: hidden;
    min-height: 0;
  }

  .pg-code-bar {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    gap: 12px;
    background: rgba(255, 255, 255, 0.03);
  }

  .pg-code-bar-left {
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 0;
  }

  .pg-code-tabs {
    display: flex;
    align-items: center;
    gap: 2px;
    background: rgba(255, 255, 255, 0.04);
    border-radius: 100px;
    padding: 2px;
  }

  .pg-code-tab {
    padding: 6px 12px;
    border: none;
    border-radius: 100px;
    background: transparent;
    color: rgba(255, 255, 255, 0.4);
    font-size: 13px;
    font-weight: 500;
    font-family: inherit;
    line-height: 1;
    cursor: pointer;
    transition: background 0.12s, color 0.12s;
  }

  .pg-code-tab:hover {
    color: rgba(255, 255, 255, 0.7);
  }

  .pg-code-tab--active {
    background: var(--sl-color-accent);
    color: #fff;
  }

  .pg-code-usage-select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 999px;
    background-color: rgba(255, 255, 255, 0.04);
    color: rgba(255, 255, 255, 0.82);
    height: 28px;
    font-size: 12px;
    font-family: inherit;
    padding: 0 28px 0 12px;
    line-height: 1;
    background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 14 14" fill="none"%3E%3Cpath d="M3 5.25L7 9.25L11 5.25" stroke="%23C8CDD9" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/%3E%3C/svg%3E');
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 12px 12px;
    cursor: pointer;
    transition: border-color 0.12s, color 0.12s, opacity 0.12s;
  }

  .pg-code-usage-select:hover:not(:disabled) {
    border-color: rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.95);
  }

  .pg-code-usage-select:focus-visible {
    outline: none;
    border-color: var(--sl-color-accent);
  }

  .pg-copy-btn {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.25rem 0.5rem;
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 5px;
    background: transparent;
    color: rgba(255, 255, 255, 0.4);
    font-size: 0.6875rem;
    font-family: inherit;
    cursor: pointer;
    transition: color 0.15s, border-color 0.15s;
    margin-left: auto;
  }

  .pg-copy-btn:hover {
    color: rgba(255, 255, 255, 0.8);
    border-color: rgba(255, 255, 255, 0.15);
  }

  .pg-code-scroll {
    flex: 1;
    overflow: auto;
    padding: 0.75rem 1rem;
  }

  .pg-pre {
    margin: 0;
    white-space: pre;
    font-family: 'JetBrains Mono', var(--sl-font-mono);
    font-size: 0.8125rem;
    line-height: 1.65;
    color: #ABB2BF;
  }

  .pg-pre code {
    background: none;
    font-family: inherit;
    font-size: inherit;
    padding: 0;
    border: none;
  }

  /* Prism One Dark Pro theme (global — dynamic innerHTML has no scoping attrs) */
  .pg-pre :global(.token.comment),
  .pg-pre :global(.token.prolog),
  .pg-pre :global(.token.doctype),
  .pg-pre :global(.token.cdata) { color: #5C6370; font-style: italic; }

  .pg-pre :global(.token.punctuation) { color: #ABB2BF; }

  .pg-pre :global(.token.tag) { color: #E06C75; }
  .pg-pre :global(.token.selector) { color: #E06C75; }

  .pg-pre :global(.token.attr-name) { color: #D19A66; }

  .pg-pre :global(.token.string),
  .pg-pre :global(.token.char),
  .pg-pre :global(.token.attr-value),
  .pg-pre :global(.token.template-string) { color: #98C379; }

  .pg-pre :global(.token.keyword) { color: #C678DD; }
  .pg-pre :global(.token.operator) { color: #C678DD; }

  .pg-pre :global(.token.boolean),
  .pg-pre :global(.token.number),
  .pg-pre :global(.token.constant) { color: #D19A66; }

  .pg-pre :global(.token.function),
  .pg-pre :global(.token.class-name) { color: #61AFEF; }

  .pg-pre :global(.token.script) { color: #ABB2BF; }

  .pg-pre :global(.token.attr-value .token.punctuation) { color: #98C379; }

  /* ── Widget Preview ── */
  .pg-widget {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 16px;
    min-height: 460px;
  }

  .pg-widget-mount {
    width: 100%;
    max-width: 400px;
    filter: drop-shadow(0 8px 32px rgba(0, 0, 0, 0.12));
  }

  /* ── Responsive ── */
  @media (max-width: 1023px) {
    .pg-grid {
      grid-template-columns: 200px 1fr;
      grid-template-rows: auto auto;
      height: auto;
    }

    .pg-code {
      grid-column: 1 / -1;
      grid-row: 2;
      min-height: 260px;
      border-right: none;
      border-top: 1px solid var(--pg-border);
    }

    .pg-widget {
      min-height: 400px;
    }
  }

  @media (max-width: 767px) {
    .pg-container {
      border-radius: 14px;
    }

    .pg-grid {
      grid-template-columns: 1fr;
      height: auto;
    }

    .pg-controls {
      order: 1;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 1rem;
      border-right: none;
      border-bottom: 1px solid var(--pg-border);
    }

    .pg-widget {
      order: 2;
    }

    .pg-code {
      order: 3;
      border-right: none;
      border-top: 1px solid var(--pg-border);
    }

    .pg-section {
      min-width: 140px;
      flex: 1;
      margin-bottom: 0;
    }

    .pg-divider {
      display: none;
    }

    .pg-presets {
      gap: 6px;
    }

    .pg-code {
      grid-column: auto;
      grid-row: auto;
      min-height: 220px;
    }

    .pg-widget {
      min-height: 420px;
    }

  }


</style>
